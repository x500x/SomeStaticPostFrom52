<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1.0"><title>帖子内容</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script>hljs.highlightAll();</script><style>*{word-wrap:break-word}body,html{margin:0;padding:0;width:93%;height:100%}.table-container{width:93vw;overflow-x:auto}table{margin:.25em auto;width:100%;max-width:100%;table-layout:auto;overflow:auto;border-spacing:0;border-collapse:collapse}table tr:nth-child(2n){background-color:#f6f8fa}table thead{background-color:#d9e2df}table th{font-weight:600}table tr{border-top:1px solid #c6cbd1}table td,table th{padding:6px 13px;border:1px solid #c6cbd1 text-align:center}pre{background-color:#F8F8F8;border:1px solid #CCCCCC;border-radius:3px;padding:2px;overflow-x:auto;width:100%;box-sizing:border-box}code{font-family:Consolas,Monaco,Andale Mono,monospace;background-color:#f5f5f5}pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{background:#000;color:#f8f8f8}.hljs-comment,.hljs-meta,.hljs-quote{color:#7c7c7c}.hljs-keyword,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#96cbfe}.hljs-attribute,.hljs-selector-id{color:#ffffb6}.hljs-addition,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string{color:#a8ff60}.hljs-subst{color:#daefa3}.hljs-link,.hljs-regexp{color:#e9c062}.hljs-doctag,.hljs-section,.hljs-title,.hljs-type{color:#ffffb6}.hljs-bullet,.hljs-literal,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#c6c5fe}.hljs-deletion,.hljs-number{color:#ff73fd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.container{width:100%;margin:20px auto;padding:20px;border-radius:8px;word-wrap:break-word}.postcontent{width:100%;margin-bottom:20px;border-bottom:3px solid #e0f7ff;padding-bottom:10px;word-wrap:break-word}.postcontent:last-child{border-bottom:none}.postcontent h1{margin:0 0 10px;font-size:24px}.postcontent p{margin:0 0 10px;font-size:16px}.postcontent .author{font-size:14px;color:#555}.postcontent .timestamp{font-size:12px;color:#888}.postcontent blockquote{border-left:4px solid #ccc;padding:5px 10px;margin:10px 0;background:#f9f9f9}.postcontent blockquote cite{display:block;text-align:right;font-size:12px;color:#555}.postcontent img{max-width:100%;height:auto;margin:10px 0}.postcontent table{width:100%;border-collapse:collapse;margin:10px 0}.postcontent table th,.postcontent table td{border:1px solid #ddd;padding:8px;text-align:left}.postcontent button{background:#007bff;color:#fff;border:none;padding:10px 20px;font-size:16px;cursor:pointer;border-radius:5px}.postcontent button:hover{background:#0056b3}.comment-container{width:90%;margin:20px auto;border:1px solid #f0f0f0;padding:20px;border-radius:5px;font-family:Arial,sans-serif}.comment-header{background-color:#fff7e6;padding:10px;border-left:5px solid #ff5722;margin:-20px -20px 20px;border-radius:5px 5px 0 0;font-weight:bold}.comment-body{margin-top:10px}.comment-author{font-size:18px;color:#333}.comment-text{font-size:16px;color:#555}.comment-time{text-align:right;color:#999;margin-top:10px}</style><div id=zxsq-markdown-code-tools style=display:none;><span class=show>显示代码</span><span class=hide>隐藏代码</span><span class=copy>复制代码</span><span class=copysucc style=display:none>代码已复制到剪贴板</span></div><script>(function(){function n(n,t=1500){var e=document.createElement("div");e.style.position="fixed",e.style.top="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.padding="10px",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.color="white",e.style.borderRadius="5px",e.style.zIndex="10000",e.innerHTML=n,document.body.appendChild(e),setTimeout(()=>{document.body.removeChild(e)},t)}function t(t,e){var o=document.createElement("textarea");o.value=t,o.style.position="fixed",o.style.opacity="0",document.body.appendChild(o),o.select();try{document.execCommand("copy")&&n(e)}catch(t){console.error("Failed to copy",t)}document.body.removeChild(o)}function e(){var e=document.getElementById("zxsq-markdown-code-tools"),o=e.querySelector(".show").innerText,c=e.querySelector(".hide").innerText,d=e.querySelector(".copy").innerText,i=e.querySelector(".copysucc").innerText;document.querySelectorAll("pre").forEach(e=>{if("hideCode"===e.firstChild.className||"CopyMyCode"===e.firstChild.className||"showCode"===e.firstChild.className)return;var r=document.createElement("div");r.style.display="flex",r.style.justifyContent="flex-start",r.style.alignItems="center",r.style.marginBottom="10px";var a=document.createElement("em");a.className="CopyMyCode",a.style="cursor:pointer;font-size:12px;color:#369 !important;margin-right:10px;",a.innerText=d,r.appendChild(a),a.onclick=function(){t(this.parentElement.parentElement.lastChild.innerText,i)};var s=document.createElement("em");s.className="hideCode",s.style="cursor:pointer;font-size:12px;color:#369 !important;",s.innerText=c,r.appendChild(s),s.onclick=function(){var n=this.parentElement.parentElement.lastChild;"hideCode"===this.className?(n.style.display="none",this.className="showCode",this.innerText=o):(n.style.display="block",this.className="hideCode",this.innerText=c)},e.insertBefore(r,e.firstChild)})}
window.addEventListener("load",e)})();</script></head><body><div class=container><p>原帖地址:https://www.52pojie.cn/thread-1525477-1-1.html</p><div class=postcontent><h1>楼主</h1><div class=author>aswcy815174418</div><div class=timestamp>2021-10-10 13:13</div><i class=pstatus> 本帖最后由 aswcy815174418 于 2021-10-11 07:33 编辑 </i><br><p>Shadow SSDT这里面所有的函数都来自于一个win32k.sys，我看很多网上的办法是Attach Process(附加一个可以访问Shadow SSDT)的进程，如果逆过Attach Process，这个函数的本质就是切换Cr3.    </p><p><strong>自己的猜想: 自己手动切换cr3(一个可以访问Shadow SSDT)，之后获取win32k.sys的dos头位置，获取到pde，然后切换回自己的驱动进程，修改驱动程序的pde，即可达到不调用api实现访问Shadow SSDT</strong></p><p>[b]运行的函数头:void AffiliatedPhysical();   从这个函数头开始看</p><p><strong>至于获取可以访问Shadow SSDT的进程，比如explorere.exe就可以，获取这个进程的cr3，你可以先通过全局句柄表获取eprocess结构体<br></strong></p><pre><code>unsigned int GetDllBase(PVOID frm,int flag) {
        UNICODE_STRING* BaseDllName = frm;
        if (flag == 1) {
                LPSTR FunName = frm;
                UNICODE_STRING us;
                ANSI_STRING as;
                as.Length = strlen(FunName);
                as.MaximumLength = strlen(FunName) + 1;
                as.Buffer = FunName;
                RtlAnsiStringToUnicodeString(&amp;us, &amp;as, TRUE);
                BaseDllName = &amp;us
        }

        LDR_DATA_TABLE_ENTRY* pLdr = pDriverObject-&gt;DriverSection;
        do {
                //DbgPrint("\nDllName: %wZ\nDllBase: %x\n", &amp;pLdr-&gt;BaseDllName, pLdr-&gt;DllBase);
                if (!RtlCompareUnicodeString(BaseDllName, &amp;pLdr-&gt;BaseDllName, TRUE)) {
                        return pLdr-&gt;DllBase;
                }
                pLdr = pLdr-&gt;InLoadOrderLinks.Blink;
        } while (pLdr-&gt;DllBase);

        return 0;
}

unsigned int* GetPDE(unsigned int VirtualAddr) {
        unsigned int JudgePAE = 0;
        _asm {
                mov eax, cr0;
                and eax, 0x10;
                mov JudgePAE, eax;
        }
        if (JudgePAE) {
                return 0xC0600000 + ((VirtualAddr &gt;&gt; 18) &amp; 0x3ff8);
        }
        return 0xC0300000 + (VirtualAddr &gt;&gt; 22) * 4;
}

unsigned int* GetPTE(unsigned int VirtualAddr) {
        unsigned int JudgePAE = 0;
        _asm {
                mov eax, cr0;
                and eax, 0x10;
                mov JudgePAE, eax;
        }
        if (JudgePAE) {
                return 0xC0000000 + ((VirtualAddr &gt;&gt; 9) &amp; 0x7ffff8);
        }
        return 0xC0000000 + (VirtualAddr &gt;&gt; 22) * 0x1000 + ((VirtualAddr &lt;&lt; 10) &gt;&gt; 22) * 4;
}

unsigned int GetEProcess(LPSTR ImageFileName) {
        unsigned int** PspCidTable;
        _asm {
                mov eax, dword ptr ds:[0xffdff000 + 0x34];
                mov eax, dword ptr ds : [eax + 0x80];
                mov eax, dword ptr ds : [eax];
                and eax, 0xFFFFFFFC;
                mov PspCidTable, eax;
        }

        int i = 0;
        while (*PspCidTable) {

                for (size_t j = 2; j &lt; 0x800; j += 2) {

                        OBJECT_HEADER* Head = (PspCidTable[i][j] &amp; 0xFFFFFFFE) - 0x18;

                        if (MmIsAddressValid(Head)) {

                                OBJECT_TYPE* TypeName = Head-&gt;Type;

                                if (!wcscmp(L"Process", TypeName-&gt;Name.Buffer)) {

                                        unsigned char* Name = (PspCidTable[i][j] &amp; 0xFFFFFFFE) + 0x174;

                                        if (!strcmp(Name, ImageFileName)) {

                                                return PspCidTable[i][j] &amp; 0xFFFFFFFE;
                                        }
                                }
                        }
                }
                i++;
                PspCidTable++;
        }
        return 0;
}

//给驱动挂上win32k物理页
void AffiliatedPhysical() {
        unsigned int Eprocess = GetEProcess("explorer.exe");
        unsigned int rr3 = *(unsigned int*)(Eprocess + 0x18);

        _asm {
                cli;
                mov eax, cr3;
                push eax;
                mov eax, rr3;
                mov cr3, eax;
        }

        unsigned int PDE = *GetPDE(GetDllBase("win32k.sys", 1));

        _asm {
                pop eax;
                mov cr3, eax;
                sti;
        }

        *GetPDE(GetDllBase("win32k.sys", 1)) = PDE;

        DbgPrint("挂载物理页成功了!\n");
}
</code></pre><div class=parsedown-markdown-end_FLAG_ZXSQ style=display:none></div></div><div class=postcontent><h1>沙发</h1><div class=author>王小乐哟丶</div><div class=timestamp>2021-10-10 13:34</div> 期待楼主上代码，~~~~~~~~~~~~~~~~~ </div><div class=postcontent><h1>3#</h1><div class=author>hubohang</div><div class=timestamp>2021-10-11 22:12</div> 这是干啥的？ </div><div class=postcontent><h1>4#</h1><div class=author>aswcy815174418</div><div class=timestamp>2021-10-16 15:50</div><div class=quote><blockquote><font size=2><a href="https://www.52pojie.cn/forum.php?mod=redirect&goto=findpost&pid=40293315&ptid=1525477" target=_blank><font color=#999999>hubohang 发表于 2021-10-11 22:12</font></a></font><br> 这是干啥的？</blockquote></div><br> 驱动程序直接访问Shadow SSDT表 </div><div class=postcontent><h1>5#</h1><div class=author>spawn_fly</div><div class=timestamp>2021-10-27 08:46</div> 谢谢分享 </div><div class=postcontent><h1>6#</h1><div class=author>火吻520</div><div class=timestamp>2021-10-30 22:48</div> 谢谢分享 </div><div class=postcontent><h1>7#</h1><div class=author>gcode</div><div class=timestamp>2021-10-31 19:54</div> 正在学C++，新手不怎么看得懂 </div><div class=postcontent><h1>8#</h1><div class=author>aswcy815174418</div><div class=timestamp>2021-10-31 22:29</div><div class=quote><blockquote><font size=2><a href="https://www.52pojie.cn/forum.php?mod=redirect&goto=findpost&pid=40491114&ptid=1525477" target=_blank><font color=#999999>gcode 发表于 2021-10-31 19:54</font></a></font><br> 正在学C++，新手不怎么看得懂</blockquote></div><br> 还是先打基础吧 </div><div class=postcontent><h1>9#</h1><div class=author>liyuan689</div><div class=timestamp>2021-12-9 09:47</div> 这个思路很不错，我试试 </div></div></body></html>