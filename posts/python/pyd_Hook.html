<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width, initial-scale=1.0"><title>å¸–å­å†…å®¹</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js></script><script>hljs.highlightAll();</script><style>*{word-wrap:break-word}body,html{margin:0;padding:0;width:93%;height:100%}.table-container{width:93vw;overflow-x:auto}table{margin:.25em auto;width:100%;max-width:100%;table-layout:auto;overflow:auto;border-spacing:0;border-collapse:collapse}table tr:nth-child(2n){background-color:#f6f8fa}table thead{background-color:#d9e2df}table th{font-weight:600}table tr{border-top:1px solid #c6cbd1}table td,table th{padding:6px 13px;border:1px solid #c6cbd1 text-align:center}pre{background-color:#F8F8F8;border:1px solid #CCCCCC;border-radius:3px;padding:2px;overflow-x:auto;width:100%;box-sizing:border-box}code{font-family:Consolas,Monaco,Andale Mono,monospace;background-color:#f5f5f5}pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{background:#000;color:#f8f8f8}.hljs-comment,.hljs-meta,.hljs-quote{color:#7c7c7c}.hljs-keyword,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#96cbfe}.hljs-attribute,.hljs-selector-id{color:#ffffb6}.hljs-addition,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string{color:#a8ff60}.hljs-subst{color:#daefa3}.hljs-link,.hljs-regexp{color:#e9c062}.hljs-doctag,.hljs-section,.hljs-title,.hljs-type{color:#ffffb6}.hljs-bullet,.hljs-literal,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#c6c5fe}.hljs-deletion,.hljs-number{color:#ff73fd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.container{width:100%;margin:20px auto;padding:20px;border-radius:8px;word-wrap:break-word}.postcontent{width:100%;margin-bottom:20px;border-bottom:3px solid #e0f7ff;padding-bottom:10px;word-wrap:break-word}.postcontent:last-child{border-bottom:none}.postcontent h1{margin:0 0 10px;font-size:24px}.postcontent p{margin:0 0 10px;font-size:16px}.postcontent .author{font-size:14px;color:#555}.postcontent .timestamp{font-size:12px;color:#888}.postcontent blockquote{border-left:4px solid #ccc;padding:5px 10px;margin:10px 0;background:#f9f9f9}.postcontent blockquote cite{display:block;text-align:right;font-size:12px;color:#555}.postcontent img{max-width:100%;height:auto;margin:10px 0}.postcontent table{width:100%;border-collapse:collapse;margin:10px 0}.postcontent table th,.postcontent table td{border:1px solid #ddd;padding:8px;text-align:left}.postcontent button{background:#007bff;color:#fff;border:none;padding:10px 20px;font-size:16px;cursor:pointer;border-radius:5px}.postcontent button:hover{background:#0056b3}.comment-container{width:90%;margin:20px auto;border:1px solid #f0f0f0;padding:20px;border-radius:5px;font-family:Arial,sans-serif}.comment-header{background-color:#fff7e6;padding:10px;border-left:5px solid #ff5722;margin:-20px -20px 20px;border-radius:5px 5px 0 0;font-weight:bold}.comment-body{margin-top:10px}.comment-author{font-size:18px;color:#333}.comment-text{font-size:16px;color:#555}.comment-time{text-align:right;color:#999;margin-top:10px}</style><div id=zxsq-markdown-code-tools style=display:none;><span class=show>æ˜¾ç¤ºä»£ç </span><span class=hide>éšè—ä»£ç </span><span class=copy>å¤åˆ¶ä»£ç </span><span class=copysucc style=display:none>ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</span></div><script>(function(){function n(n,t=1500){var e=document.createElement("div");e.style.position="fixed",e.style.top="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.padding="10px",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.color="white",e.style.borderRadius="5px",e.style.zIndex="10000",e.innerHTML=n,document.body.appendChild(e),setTimeout(()=>{document.body.removeChild(e)},t)}function t(t,e){var o=document.createElement("textarea");o.value=t,o.style.position="fixed",o.style.opacity="0",document.body.appendChild(o),o.select();try{document.execCommand("copy")&&n(e)}catch(t){console.error("Failed to copy",t)}document.body.removeChild(o)}function e(){var e=document.getElementById("zxsq-markdown-code-tools"),o=e.querySelector(".show").innerText,c=e.querySelector(".hide").innerText,d=e.querySelector(".copy").innerText,i=e.querySelector(".copysucc").innerText;document.querySelectorAll("pre").forEach(e=>{if("hideCode"===e.firstChild.className||"CopyMyCode"===e.firstChild.className||"showCode"===e.firstChild.className)return;var r=document.createElement("div");r.style.display="flex",r.style.justifyContent="flex-start",r.style.alignItems="center",r.style.marginBottom="10px";var a=document.createElement("em");a.className="CopyMyCode",a.style="cursor:pointer;font-size:12px;color:#369 !important;margin-right:10px;",a.innerText=d,r.appendChild(a),a.onclick=function(){t(this.parentElement.parentElement.lastChild.innerText,i)};var s=document.createElement("em");s.className="hideCode",s.style="cursor:pointer;font-size:12px;color:#369 !important;",s.innerText=c,r.appendChild(s),s.onclick=function(){var n=this.parentElement.parentElement.lastChild;"hideCode"===this.className?(n.style.display="none",this.className="showCode",this.innerText=o):(n.style.display="block",this.className="hideCode",this.innerText=c)},e.insertBefore(r,e.firstChild)})}
window.addEventListener("load",e)})();</script></head><body><div class=container><p>åŸå¸–åœ°å€:https://www.52pojie.cn/thread-2066492-1-1.html</p><div class=postcontent><h1>æ¥¼ä¸»</h1><div class=author>fine906</div><div class=timestamp>2025-10-17 20:43</div><i class=pstatus> æœ¬å¸–æœ€åç”± fine906 äº 2025-10-17 20:48 ç¼–è¾‘ </i><br><p>[md]åšpydçš„é¢˜åšåäº†ï¼Œæƒ³éª‚äºº</p><p>åŠ¨æ€çœ‹ï¼Œä¸€å¨</p><p>é™æ€çœ‹ï¼Œæ›´æ˜¯ä¾æ‰˜</p><p>æ‰€ä»¥ï¼Œæˆ‘è¦å†™ä¸€ä¸ªé€šç”¨çš„hookè„šæœ¬ï¼Œhhhhhhh</p><h3 id=54045883_hookç¼–å†™>Hookç¼–å†™</h3><p>åœ¨Linuxä¸‹é€šè¿‡<code>pip install Cython</code>å®‰è£…ã€‚å®‰è£…å®Œæ¯•åæ‰§è¡Œ<code>cython --version</code>ï¼Œå¦‚æœè¾“å‡ºäº†ç‰ˆæœ¬å·å³å®‰è£…æˆåŠŸã€‚</p><p>å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªhook_testé¡¹ç›®ï¼Œéœ€è¦åˆ›å»º<code>hook_test.pyx</code>å’Œ<code>setup.py</code>ä¸¤ä¸ªæ–‡ä»¶ã€‚</p><pre><code class=language-py># setup.py
from distutils.core import setup
from Cython.Build import cythonize

# setup() å‡½æ•°æ˜¯æ ¸å¿ƒï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•æ„å»ºä½ çš„æ¨¡å—
setup(
Â  Â  # 'name' å­—æ®µæ˜¯è¿™ä¸ªæ¨¡å—çš„åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
Â  Â  name='hook_test',
Â  Â  ext_modules=cythonize("hook_test.pyx")
)</code></pre><pre><code class=language-python># hook_test.pyx
def process_data(a, b, c, d, e):
Â  Â  num1 = a + b
Â  Â  print("PyNumber_Add:", num1)
Â  Â  num2 = a - b
Â  Â  print("PyNumber_Subtract:", num2)
Â  Â  num3 = a * b
Â  Â  print("PyNumber_Multiply:", num3)
Â  Â  num4 = a &amp; b
Â  Â  print("PyNumber_And:", num4)
Â  Â  num5 = a | b
Â  Â  print("PyNumber_Or:", num5)
Â  Â  num6 = a ^ b
Â  Â  print("PyNumber_Xor:", num6)
Â  Â  num7 = a &lt;&lt; 2
Â  Â  print("PyNumber_Lshift:", num7)
Â  Â  num8 = b &gt;&gt; 1
Â  Â  print("PyNumber_Rshift:", num8)
Â  Â  b &gt;&gt;= 1
Â  Â  print("PyNumber_InPlaceRshift:", b)
Â  Â  num10 = a ** 2
Â  Â  print("PyNumber_Power:", num10)
Â  Â  num11 = a % 100
Â  Â  print("PyNumber_Remainder:", num11)
Â  Â  num13 = e[0]
Â  Â  print("PyNumber_Index:", num13)
Â  Â  c += a
Â  Â  print("PyNumber_InPlaceAdd:", c)
Â  Â  return a == b</code></pre><p>ç„¶åä½¿ç”¨ä¸‹è¿°å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼š</p><p><code>python setup.py build_ext --inplace</code></p><p>è·å¾—<code>pyd</code>æ–‡ä»¶</p><p>éšåï¼š</p><pre><code class=language-python># challenge.py
import hook_test
import os
import sys
print(sys.executable)
print(os.getpid())

if hasattr(sys, "set_int_max_str_digits"):
Â  Â  sys.set_int_max_str_digits(0)
# å‡†å¤‡è¾“å…¥æ•°æ®
a = 1234345
b = 67890
c = 13579
d = 24680
e = [42,53]
# è°ƒç”¨ Cython å‡½æ•°
input()
hook_test.process_data(a, b, c, d, e)
print("è°ƒç”¨æˆåŠŸ")</code></pre><p>é¦–å…ˆè¿è¡Œchallenge.pyï¼Œç„¶åè¿è¡Œhookä»£ç å³å¯ï¼š<code>frida -p 14240 -l hook_05.js</code></p><pre><code class=language-js>'use strict';
/**
 * ======================================================
 * Frida hook script for Python3 numeric &amp; compare ops
 * - Hooks PyNumber_* (åŠ å‡ä¹˜é™¤ã€ä½è¿ç®—ã€å–ä½™ã€ç§»ä½ã€æ¨¡å¹‚)
 * - Hooks PyObject_RichCompareBool / PyObject_RichCompare (æ¯”è¾ƒ)
 * - Hooks PyLong_FromString / PyLong_FromUnicodeObject
 * - Fixed type error: use int64/uint64 instead of longlong
 * - Added fixed-width HEX output (e.g. 0x12345678)
 * ======================================================
 */

const logFilePath = "./log.txt";
const logFile = new File(logFilePath, "w");

function logLine(s) {
Â  Â  logFile.write(s + "\n");
Â  Â  logFile.flush();
Â  Â  console.log(s);
}

// ---------------------------------------------------------------------

function findPythonModule() {
Â  Â  const mods = Process.enumerateModulesSync();
Â  Â  for (const m of mods) {
Â  Â Â  Â Â Â const n = m.name.toLowerCase();
Â  Â Â  Â Â Â if (n.startsWith('python3') &amp;&amp; n.endsWith('.dll')) return m;
Â  Â Â  Â Â Â if (n.startsWith('python') &amp;&amp; n.endsWith('.dll')) return m;
Â  Â  }
Â  Â  throw new Error('python3*.dll not found. Use: frida -f python.exe -l hook_number_compare.js');
}

const pymod = findPythonModule();
logLine(' using python module: ' + pymod.name + ' ' + pymod.base);

// safe wrapper to resolve exports and print status
function exp(name) {
Â  Â  try {
Â  Â Â  Â Â Â const addr = Module.getExportByName(pymod.name, name);
Â  Â Â  Â Â Â logLine(`[+] export ${name} =&gt; ${addr}`);
Â  Â Â  Â Â Â return addr;
Â  Â  } catch (e) {
Â  Â Â  Â Â Â logLine(`[-] export ${name} not found`);
Â  Â Â  Â Â Â return null;
Â  Â  }
}

// ---------------------------------------------------------------------

// list of symbols
const symbols = {
Â  Â  PyUnicode_AsUTF8: exp('PyUnicode_AsUTF8'),
Â  Â  PyObject_Repr: exp('PyObject_Repr'),
Â  Â  PyObject_Str: exp('PyObject_Str'),
Â  Â  PyLong_Check: exp('PyLong_Check'),
Â  Â  PyLong_AsLongLong: exp('PyLong_AsLongLong'),
Â  Â  PyLong_AsUnsignedLongLongMask: exp('PyLong_AsUnsignedLongLongMask'),
Â  Â  PyLong_FromString: exp('PyLong_FromString'),
Â  Â  PyLong_FromUnicodeObject: exp('PyLong_FromUnicodeObject'),
Â  Â  PyNumber_Add: exp('PyNumber_Add'),
Â  Â  PyNumber_InPlaceAdd: exp('PyNumber_InPlaceAdd'),
Â  Â  PyNumber_Subtract: exp('PyNumber_Subtract'),
Â  Â  PyNumber_Multiply: exp('PyNumber_Multiply'),
Â  Â  PyNumber_And: exp('PyNumber_And'),
Â  Â  PyNumber_Or: exp('PyNumber_Or'),
Â  Â  PyNumber_Xor: exp('PyNumber_Xor'),
Â  Â  PyNumber_Lshift: exp('PyNumber_Lshift'),
Â  Â  PyNumber_Rshift: exp('PyNumber_Rshift'),
Â  Â  PyNumber_InPlaceRshift: exp('PyNumber_InPlaceRshift'),
Â  Â  PyNumber_Power: exp('PyNumber_Power'),
Â  Â  PyNumber_Remainder: exp('PyNumber_Remainder'),
Â  Â  PyNumber_Index: exp('PyNumber_Index'),
Â  Â  PyObject_RichCompare: exp('PyObject_RichCompare'),
Â  Â  PyObject_RichCompareBool: exp('PyObject_RichCompareBool')
};

function tryCreateNativeFunction(addr, retType, argTypes, friendlyName) {
Â  Â  if (!addr) return null;
Â  Â  try {
Â  Â Â  Â Â Â const nf = new NativeFunction(addr, retType, argTypes);
Â  Â Â  Â Â Â logLine(`[+] NativeFunction created for ${friendlyName}`);
Â  Â Â  Â Â Â return nf;
Â  Â  } catch (e) {
Â  Â Â  Â Â Â logLine(`[-] Failed creating NativeFunction for ${friendlyName}: ${e.message}`);
Â  Â Â  Â Â Â return null;
Â  Â  }
}

const PyUnicode_AsUTF8 = tryCreateNativeFunction(symbols.PyUnicode_AsUTF8, 'pointer', ['pointer'], 'PyUnicode_AsUTF8');
const PyObject_Repr = tryCreateNativeFunction(symbols.PyObject_Repr, 'pointer', ['pointer'], 'PyObject_Repr');
const PyObject_Str = tryCreateNativeFunction(symbols.PyObject_Str, 'pointer', ['pointer'], 'PyObject_Str');
const PyLong_Check = tryCreateNativeFunction(symbols.PyLong_Check, 'int', ['pointer'], 'PyLong_Check');
const PyLong_AsLongLong = tryCreateNativeFunction(symbols.PyLong_AsLongLong, 'int64', ['pointer'], 'PyLong_AsLongLong');
const PyLong_AsUnsignedLongLongMask = tryCreateNativeFunction(symbols.PyLong_AsUnsignedLongLongMask, 'uint64', ['pointer'], 'PyLong_AsUnsignedLongLongMask');

// ---------------------------------------------------------------------

function toHexFixed(num, width = 8) {
Â  Â  try {
Â  Â Â  Â Â Â let big;
Â  Â Â  Â Â Â if (typeof num === 'bigint') big = num;
Â  Â Â  Â Â Â else if (typeof num === 'number') big = BigInt(num &gt;&gt;&gt; 0);
Â  Â Â  Â Â Â else if (typeof num === 'string') {
Â  Â Â  Â Â  Â Â  Â if (/^0x[0-9a-fA-F]+$/.test(num)) big = BigInt(num);
Â  Â Â  Â Â  Â Â  Â else if (/^-?\d+$/.test(num)) {
Â  Â Â  Â Â  Â Â  Â Â  Â  big = BigInt(num);
Â  Â Â  Â Â  Â Â  Â Â  Â  if (big &lt; 0n) {
Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â Â const bits = BigInt(width * 4);
Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â Â big = (big &amp; ((1n &lt;&lt; bits) - 1n));
Â  Â Â  Â Â  Â Â  Â Â  Â  }
Â  Â Â  Â Â  Â Â  Â } else return num;
Â  Â Â  Â Â Â } else return `&lt;hex error: ${typeof num}&gt;`;
Â  Â Â  Â Â Â let hex = big.toString(16);
Â  Â Â  Â Â Â if (hex.length &lt; width) hex = hex.padStart(width, '0');
Â  Â Â  Â Â Â return '0x' + hex;
Â  Â  } catch (e) {
Â  Â Â  Â Â Â return `&lt;hex error: ${e.message}&gt;`;
Â  Â  }
}

function isDecimalString(s) {
Â  Â  return typeof s === 'string' &amp;&amp; /^-?\d+$/.test(s);
}
function isHexString(s) {
Â  Â  return typeof s === 'string' &amp;&amp; /^0x[0-9a-fA-F]+$/.test(s);
}

function formatForLogging(s, width = 8) {
Â  Â  if (s === undefined || s === null) return s;
Â  Â  if (isHexString(s)) return s;
Â  Â  if (isDecimalString(s)) return toHexFixed(s, width);
Â  Â  const m = /(-?\d+)$/.exec(String(s).trim());
Â  Â  if (m) return toHexFixed(m[1], width);
Â  Â  return s;
}

function safeUtf8FromPyStr(pyStrPtr) {
Â  Â  if (!pyStrPtr || pyStrPtr.isNull()) return '&lt;utf8 NULL&gt;';
Â  Â  try {
Â  Â Â  Â Â Â if (!PyUnicode_AsUTF8) return '&lt;no PyUnicode_AsUTF8&gt;';
Â  Â Â  Â Â Â const cstr = PyUnicode_AsUTF8(pyStrPtr);
Â  Â Â  Â Â Â if (cstr.isNull()) return '&lt;utf8 NULL&gt;';
Â  Â Â  Â Â Â return Memory.readUtf8String(cstr);
Â  Â  } catch {
Â  Â Â  Â Â Â return '&lt;utf8 read error&gt;';
Â  Â  }
}

function objToStr(pyObjPtr) {
Â  Â  if (!pyObjPtr || pyObjPtr.isNull()) return '&lt;NULL&gt;';
Â  Â  try {
Â  Â Â  Â Â Â if (PyLong_Check) {
Â  Â Â  Â Â  Â Â  Â const isLong = PyLong_Check(pyObjPtr);
Â  Â Â  Â Â  Â Â  Â if (isLong === 1) {
Â  Â Â  Â Â  Â Â  Â Â  Â  if (PyLong_AsUnsignedLongLongMask) {
Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â Â const u = PyLong_AsUnsignedLongLongMask(pyObjPtr);
Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â Â return toHexFixed(u);
Â  Â Â  Â Â  Â Â  Â Â  Â  }
Â  Â Â  Â Â  Â Â  Â Â  Â  if (PyLong_AsLongLong) {
Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â Â const v = PyLong_AsLongLong(pyObjPtr);
Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â Â return toHexFixed(v);
Â  Â Â  Â Â  Â Â  Â Â  Â  }
Â  Â Â  Â Â  Â Â  Â }
Â  Â Â  Â Â Â }
Â  Â Â  Â Â Â if (PyObject_Str) {
Â  Â Â  Â Â  Â Â  Â const sObj = PyObject_Str(pyObjPtr);
Â  Â Â  Â Â  Â Â  Â if (sObj &amp;&amp; !sObj.isNull()) return safeUtf8FromPyStr(sObj);
Â  Â Â  Â Â Â }
Â  Â Â  Â Â Â if (PyObject_Repr) {
Â  Â Â  Â Â  Â Â  Â const r = PyObject_Repr(pyObjPtr);
Â  Â Â  Â Â  Â Â  Â if (r &amp;&amp; !r.isNull()) return safeUtf8FromPyStr(r);
Â  Â Â  Â Â Â }
Â  Â Â  Â Â Â return '&lt;unrepresentable&gt;';
Â  Â  } catch (e) {
Â  Â Â  Â Â Â return `&lt;repr error: ${e.message}&gt;`;
Â  Â  }
}

// ---------------------------------------------------------------------

// Hook PyLong_FromUnicodeObject / PyLong_FromString
if (symbols.PyLong_FromUnicodeObject) {
Â  Â  Interceptor.attach(symbols.PyLong_FromUnicodeObject, {
Â  Â Â  Â Â Â onEnter(args) {
Â  Â Â  Â Â  Â Â  Â this.sRaw = objToStr(args[0]);
Â  Â Â  Â Â  Â Â  Â this.base = args[1].toInt32();
Â  Â Â  Â Â Â },
Â  Â Â  Â Â Â onLeave(retval) {
Â  Â Â  Â Â  Â Â  Â const got = objToStr(retval);
Â  Â Â  Â Â  Â Â  Â logLine(`[PyLong_FromUnicodeObject] int(s, base=${this.base}) s=${this.sRaw} -&gt; ${formatForLogging(got)}`);
Â  Â Â  Â Â Â }
Â  Â  });
}

if (symbols.PyLong_FromString) {
Â  Â  Interceptor.attach(symbols.PyLong_FromString, {
Â  Â Â  Â Â Â onEnter(args) {
Â  Â Â  Â Â  Â Â  Â try { this.s = Memory.readUtf8String(args[0]); } catch (e) { this.s = '&lt;read error&gt;'; }
Â  Â Â  Â Â  Â Â  Â this.base = args[2].toInt32();
Â  Â Â  Â Â Â },
Â  Â Â  Â Â Â onLeave(retval) {
Â  Â Â  Â Â  Â Â  Â const got = objToStr(retval);
Â  Â Â  Â Â  Â Â  Â logLine(`[PyLong_FromString] int(s, base=${this.base}) s=${this.s} -&gt; ${formatForLogging(got)}`);
Â  Â Â  Â Â Â }
Â  Â  });
}

function symbolFor(name) {
Â  Â  const map = {
Â  Â Â  Â Â Â PyNumber_Add: '+',
Â  Â Â  Â Â Â PyNumber_InPlaceAdd: '+=',
Â  Â Â  Â Â Â PyNumber_Subtract: '-',
Â  Â Â  Â Â Â PyNumber_Multiply: '*',
Â  Â Â  Â Â Â PyNumber_And: '&amp;',
Â  Â Â  Â Â Â PyNumber_Or: '|',
Â  Â Â  Â Â Â PyNumber_Xor: '^',
Â  Â Â  Â Â Â PyNumber_Lshift: '&lt;&lt;',
Â  Â Â  Â Â Â PyNumber_Rshift: '&gt;&gt;',
Â  Â Â  Â Â Â PyNumber_InPlaceRshift: '&gt;&gt;=',
Â  Â Â  Â Â Â PyNumber_Power: '**',
Â  Â Â  Â Â Â PyNumber_Remainder: '%',
Â  Â Â  Â Â Â PyNumber_Index: 'index'
Â  Â  };
Â  Â  return map[name] || '?';
}

// ---------------------------------------------------------------------
//
// function hookPyNumber(name, ptr) {
//Â  Â Â Â if (!ptr) return;
//Â  Â Â Â Interceptor.attach(ptr, {
//Â  Â Â  Â Â  Â onEnter(args) {
//Â  Â Â  Â Â  Â Â  Â  this.aPtr = args[0];
//Â  Â Â  Â Â  Â Â  Â  this.bPtr = args[1];
//Â  Â Â  Â Â  Â Â  Â  this.aRaw = objToStr(this.aPtr);
//Â  Â Â  Â Â  Â Â  Â  this.bRaw = objToStr(this.bPtr);
//Â  Â Â  Â Â  Â Â  Â  this.a = formatForLogging(this.aRaw, 8);
//Â  Â Â  Â Â  Â Â  Â  this.b = formatForLogging(this.bRaw, 8);
//Â  Â Â  Â Â  Â Â  Â  try {
//Â  Â Â  Â Â  Â Â  Â Â  Â Â Â this.cPtr = args[2];
//Â  Â Â  Â Â  Â Â  Â Â  Â Â Â if (this.cPtr &amp;&amp; !this.cPtr.isNull()) {
//Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â this.cRaw = objToStr(this.cPtr);
//Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â this.c = formatForLogging(this.cRaw, 8);
//Â  Â Â  Â Â  Â Â  Â Â  Â Â Â } else {
//Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â this.cPtr = null;
//Â  Â Â  Â Â  Â Â  Â Â  Â Â Â }
//Â  Â Â  Â Â  Â Â  Â  } catch (e) { this.cPtr = null; }
//Â  Â Â  Â Â  Â },
//Â  Â Â  Â Â  Â onLeave(retval) {
//Â  Â Â  Â Â  Â Â  Â  if (name === 'PyNumber_Power') {
//Â  Â Â  Â Â  Â Â  Â Â  Â Â Â if (this.cPtr) {
//Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â logLine(`[${name}] pow(${this.a}, ${this.b}, ${this.c}) = ${formatForLogging(objToStr(retval), 8)}`);
//Â  Â Â  Â Â  Â Â  Â Â  Â Â Â } else {
//Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â logLine(`[${name}] ${this.a} ** ${this.b} = &lt;suppressed&gt;`);
//Â  Â Â  Â Â  Â Â  Â Â  Â Â Â }
//Â  Â Â  Â Â  Â Â  Â Â  Â Â Â return;
//Â  Â Â  Â Â  Â Â  Â  }
//Â  Â Â  Â Â  Â Â  Â  logLine(`[${name}] ${this.a} ${symbolFor(name)} ${this.b} = ${formatForLogging(objToStr(retval), 8)}`);
//Â  Â Â  Â Â  Â }
//Â  Â Â Â });
// }

function hookPyNumber(name, ptr) {
Â  Â  if (!ptr) return;
Â  Â  Interceptor.attach(ptr, {
Â  Â Â  Â Â Â onEnter(args) {
Â  Â Â  Â Â  Â Â  Â // onEnter çš„é€»è¾‘ä¿æŒä¸å˜ï¼Œä¾ç„¶æ˜¯æ•è·åŸå§‹æŒ‡é’ˆå’Œå­—ç¬¦ä¸²
Â  Â Â  Â Â  Â Â  Â this.aPtr = args[0];
Â  Â Â  Â Â  Â Â  Â this.bPtr = args[1];
Â  Â Â  Â Â  Â Â  Â this.aRaw = objToStr(this.aPtr);
Â  Â Â  Â Â  Â Â  Â this.bRaw = objToStr(this.bPtr);
Â  Â Â  Â Â  Â Â  Â this.a = formatForLogging(this.aRaw, 8);
Â  Â Â  Â Â  Â Â  Â this.b = formatForLogging(this.bRaw, 8);

Â  Â Â  Â Â  Â Â  Â try {
Â  Â Â  Â Â  Â Â  Â Â  Â  this.cPtr = args[2];
Â  Â Â  Â Â  Â Â  Â Â  Â  if (this.cPtr &amp;&amp; !this.cPtr.isNull()) {
Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â Â this.cRaw = objToStr(this.cPtr);
Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â Â this.c = formatForLogging(this.cRaw, 8);
Â  Â Â  Â Â  Â Â  Â Â  Â  } else {
Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â Â this.cPtr = null;
Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â Â this.cRaw = null;
Â  Â Â  Â Â  Â Â  Â Â  Â Â  Â Â Â this.c = null;
Â  Â Â  Â Â  Â Â  Â Â  Â  }
Â  Â Â  Â Â  Â Â  Â } catch (e) {
Â  Â Â  Â Â  Â Â  Â Â  Â  this.cPtr = null;
Â  Â Â  Â Â  Â Â  Â Â  Â  this.cRaw = null;
Â  Â Â  Â Â  Â Â  Â Â  Â  this.c = null;
Â  Â Â  Â Â  Â Â  Â }
Â  Â Â  Â Â Â },
Â  Â Â  Â Â Â onLeave(retval) {
Â  Â Â  Â Â  Â Â  Â // --- ä¸»è¦ä¿®æ”¹éƒ¨åˆ†åœ¨è¿™é‡Œ ---

Â  Â Â  Â Â  Â Â  Â // 1. ç»Ÿä¸€æ£€æŸ¥å¹¶å‡†å¤‡ç”¨äºæ—¥å¿—çš„å­—ç¬¦ä¸²
Â  Â Â  Â Â  Â Â  Â // æ£€æŸ¥ç¬¬ä¸€ä¸ªæ“ä½œæ•° a
Â  Â Â  Â Â  Â Â  Â let aStr = this.aRaw.length &gt; 32 ? "num" : this.a;
Â  Â Â  Â Â  Â Â  Â // æ£€æŸ¥ç¬¬äºŒä¸ªæ“ä½œæ•° b
Â  Â Â  Â Â  Â Â  Â let bStr = this.bRaw.length &gt; 32 ? "num" : this.b;
Â  Â Â  Â Â  Â Â  Â // æ£€æŸ¥è¿”å›å€¼ (c)
Â  Â Â  Â Â  Â Â  Â const outRaw = objToStr(retval);
Â  Â Â  Â Â  Â Â  Â let outFmt = outRaw.length &gt; 32 ? "num" : formatForLogging(outRaw, 8);

Â  Â Â  Â Â  Â Â  Â // 2. æ ¹æ®ä¸åŒçš„å‡½æ•°åï¼Œä½¿ç”¨å‡†å¤‡å¥½çš„å­—ç¬¦ä¸²æ¥æ ¼å¼åŒ–æ—¥å¿—
Â  Â Â  Â Â  Â Â  Â if (name === 'PyNumber_Power') {
Â  Â Â  Â Â  Â Â  Â Â  Â  // å¯¹äº pow(a, b, mod)ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¹Ÿéœ€è¦æ£€æŸ¥
Â  Â Â  Â Â  Â Â  Â Â  Â  let modStr = this.c ? (this.cRaw.length &gt; 32 ? "num" : this.c) : "None";
Â  Â Â  Â Â  Â Â  Â Â  Â  logLine(`[${name}] pow(${aStr}, ${bStr}, ${modStr}) = ${outFmt}`);
Â  Â Â  Â Â  Â Â  Â Â  Â  return;
Â  Â Â  Â Â  Â Â  Â }

Â  Â Â  Â Â  Â Â  Â // å¯¹äº PyNumber_Remainder å’Œå…¶ä»–æ‰€æœ‰äºŒå…ƒè¿ç®—
Â  Â Â  Â Â  Â Â  Â logLine(`[${name}] ${aStr} ${symbolFor(name)} ${bStr} = ${outFmt}`);
Â  Â Â  Â Â Â }
Â  Â  });
}
// ---------------------------------------------------------------------

[
Â  Â  'PyNumber_Add',
Â  Â  'PyNumber_InPlaceAdd',
Â  Â  'PyNumber_Subtract',
Â  Â  'PyNumber_Multiply',
Â  Â  'PyNumber_And',
Â  Â  'PyNumber_Or',
Â  Â  'PyNumber_Xor',
Â  Â  'PyNumber_Lshift',
Â  Â  'PyNumber_Rshift',
Â  Â  'PyNumber_InPlaceRshift',
Â  Â  'PyNumber_Remainder',
Â  Â  'PyNumber_Index',
Â  Â  'PyNumber_Power'
].forEach(n =&gt; hookPyNumber(n, symbols[n]));

// æ¯”è¾ƒæ“ä½œ
const cmpOps = ['&lt;', '&lt;=', '==', '!=', '&gt;', '&gt;='];

if (symbols.PyObject_RichCompareBool) {
Â  Â  Interceptor.attach(symbols.PyObject_RichCompareBool, {
Â  Â Â  Â Â Â onEnter(args) {
Â  Â Â  Â Â  Â Â  Â this.ptrA = args[0];
Â  Â Â  Â Â  Â Â  Â this.ptrB = args[1];
Â  Â Â  Â Â  Â Â  Â this.op = args[2].toInt32();
Â  Â Â  Â Â  Â Â  Â this.aRaw = objToStr(this.ptrA);
Â  Â Â  Â Â  Â Â  Â this.bRaw = objToStr(this.ptrB);
Â  Â Â  Â Â  Â Â  Â this.a = formatForLogging(this.aRaw, 8);
Â  Â Â  Â Â  Â Â  Â this.b = formatForLogging(this.bRaw, 8);
Â  Â Â  Â Â Â },
Â  Â Â  Â Â Â onLeave(retval) {
Â  Â Â  Â Â  Â Â  Â const opStr = cmpOps[this.op] || `op(${this.op})`;
Â  Â Â  Â Â  Â Â  Â if (this.ptrA.equals(this.ptrB)) return;
Â  Â Â  Â Â  Â Â  Â if (this.aRaw === this.bRaw &amp;&amp; this.op === 2) return;
Â  Â Â  Â Â  Â Â  Â logLine(`[CompareBool] ${this.a} ${opStr} ${this.b} -&gt; ${retval.toInt32()}`);
Â  Â Â  Â Â Â }
Â  Â  });
}

if (symbols.PyObject_RichCompare) {
Â  Â  Interceptor.attach(symbols.PyObject_RichCompare, {
Â  Â Â  Â Â Â onEnter(args) {
Â  Â Â  Â Â  Â Â  Â this.aRaw = objToStr(args[0]);
Â  Â Â  Â Â  Â Â  Â this.bRaw = objToStr(args[1]);
Â  Â Â  Â Â  Â Â  Â this.op = args[2].toInt32();
Â  Â Â  Â Â  Â Â  Â this.a = formatForLogging(this.aRaw, 8);
Â  Â Â  Â Â  Â Â  Â this.b = formatForLogging(this.bRaw, 8);
Â  Â Â  Â Â Â },
Â  Â Â  Â Â Â onLeave(retval) {
Â  Â Â  Â Â  Â Â  Â logLine(`[CompareObj] ${this.a} ${cmpOps[this.op]} ${this.b} -&gt; ${objToStr(retval)}`);
Â  Â Â  Â Â Â }
Â  Â  });
}

logLine(`\nâœ… Hooks installed on ${pymod.name}`);
logLine(`ğŸ§® PyNumber_* operations + Compare ops are now being traced in HEX...\n`);
</code></pre><p>ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œhookä¸æ˜¯ä¸‡èƒ½çš„ï¼Œhookä¸å…¨æ‰€æœ‰çš„å‡½æ•°ï¼Œæ¯”å¦‚å¯¹äºLshiftã€Rshiftç­‰é€»è¾‘æ“ä½œæ¥è¯´ï¼Œæ˜¯hookä¸åˆ°çš„ï¼Œå› ä¸ºæœ‰å¯èƒ½ä»–å°±ä¸èµ° Pyæä¾›çš„åº“å‡½æ•°ï¼Œç›´æ¥åœ¨pydä¸­è‡ªå·±å®ç°äº†</p><p>æ€»ç»“äº†ä¸€ä¸‹ï¼Œæˆ‘å†™çš„<code>hook_test</code>ï¼š</p><pre><code>PyNumber_Add: 1302235
PyNumber_Subtract: 1166455
PyNumber_Multiply: 83799682050
PyNumber_And: 288
PyNumber_Or: 1301947
PyNumber_Xor: 1301659
PyNumber_Lshift: 4937380
PyNumber_Rshift: 33945
PyNumber_InPlaceRshift: 33945
PyNumber_Power: 1523607579025
PyNumber_Remainder: 45
PyNumber_Index: 42
PyNumber_InPlaceAdd: 1247924
CompareObj</code></pre><p>ä¸€å…±14ç§ï¼Œä½†æ˜¯æˆ‘åªhookåˆ°äº†9ç§ï¼š</p><pre><code>using python module: python312.dll 0x7ffcf6920000
[+] export PyUnicode_AsUTF8 =&gt; 0x7ffcf6ac3c58
[+] export PyObject_Repr =&gt; 0x7ffcf6998af8
[+] export PyObject_Str =&gt; 0x7ffcf6998968
[-] export PyLong_Check not found
[+] export PyLong_AsLongLong =&gt; 0x7ffcf69e17d4
[+] export PyLong_AsUnsignedLongLongMask =&gt; 0x7ffcf6a9b880
[+] export PyLong_FromString =&gt; 0x7ffcf69e3d60
[+] export PyLong_FromUnicodeObject =&gt; 0x7ffcf69e35a0
[+] export PyNumber_Add =&gt; 0x7ffcf699fd9c
[+] export PyNumber_InPlaceAdd =&gt; 0x7ffcf6a76230
[+] export PyNumber_Subtract =&gt; 0x7ffcf6951bc8
[+] export PyNumber_Multiply =&gt; 0x7ffcf69e6808
[+] export PyNumber_And =&gt; 0x7ffcf6982ba8
[+] export PyNumber_Or =&gt; 0x7ffcf6951b10
[+] export PyNumber_Xor =&gt; 0x7ffcf6951ab4
[+] export PyNumber_Lshift =&gt; 0x7ffcf6a6f47c
[+] export PyNumber_Rshift =&gt; 0x7ffcf6982980
[+] export PyNumber_InPlaceRshift =&gt; 0x7ffcf6aadfa0
[+] export PyNumber_Power =&gt; 0x7ffcf6b6d228
[+] export PyNumber_Remainder =&gt; 0x7ffcf6951a58
[+] export PyNumber_Index =&gt; 0x7ffcf69ede34
[+] export PyObject_RichCompare =&gt; 0x7ffcf69e7610
[+] export PyObject_RichCompareBool =&gt; 0x7ffcf69913d8
[+] NativeFunction created for PyUnicode_AsUTF8
[+] NativeFunction created for PyObject_Repr
[+] NativeFunction created for PyObject_Str
[+] NativeFunction created for PyLong_AsLongLong
[+] NativeFunction created for PyLong_AsUnsignedLongLongMask

âœ… Hooks installed on python312.dll
ğŸ§® PyNumber_* operations + Compare ops are now being traced in HEX...

[PyNumber_Add] 0x0012d5a9 + 0x00010932 = 0x0013dedb
[PyNumber_Subtract] 0x0012d5a9 - 0x00010932 = 0x0011cc77
[PyNumber_Multiply] 0x0012d5a9 * 0x00010932 = 0x1382d9ac02
[PyNumber_And] 0x0012d5a9 &amp; 0x00010932 = 0x00000120
[PyNumber_Or] 0x0012d5a9 | 0x00010932 = 0x0013ddbb
[PyNumber_Xor] 0x0012d5a9 ^ 0x00010932 = 0x0013dc9b
[PyNumber_Power] pow(0x0012d5a9, 0x00000002, None) = 0x162be16a991
[PyNumber_InPlaceAdd] 0x0000350b += 0x0012d5a9 = 0x00130ab4
[CompareObj] 0x0012d5a9 == 0x00008499 -&gt; False
</code></pre><p>å¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œç§»ä½æˆ–è€…å–å€¼æ“ä½œæ˜¯hookä¸åˆ°çš„</p><pre><code>PyNumber_Lshift
PyNumber_Rshift
PyNumber_InPlaceRshift
PyNumber_Index
PyNumber_InPlaceAdd</code></pre><p>ä½†æ˜¯ï¼Œ<code>PyNumber_Remainder</code>å¯èƒ½å¯ä»¥</p><p>ä¾æ—§å›½èµ›åˆèµ›rand0mï¼š<br> ((int(n,16)^2654435769)&gt;&gt;11)**65537%4294967293</p><p>è¿™ä¸ªè¿ç®—é‡Œé¢çš„%å°±å¯ä»¥hookåˆ°...........<br> æˆ‘å†™çš„<code>num11 = a % 100</code>ä¸è¡Œï¼Œwocï¼Œå‡­å•¥å•Š...........</p><h3 id=54045883_å®æˆ˜ï¼ˆæˆ‘è¦ä¸€æŠŠæ¢­...ï¼‰>å®æˆ˜ï¼ˆæˆ‘è¦ä¸€æŠŠæ¢­...ï¼‰</h3><h4 id=54045883_2024ciscné•¿åŸæ¯_rand0m>2024ciscné•¿åŸæ¯_rand0m</h4><p>ä¸ç”¨idaå“ˆï¼Œç›´æ¥è·‘hook</p><p>inputï¼š<code>12345678876543211234567887654321</code></p><p>log.txt</p><pre><code>[PyLong_FromString] int(s, base=16) s=12345678 -&gt; 0x12345678
[PyLong_FromUnicodeObject] int(s, base=16) s=12345678 -&gt; 0x12345678
[PyNumber_Xor] 0x12345678 ^ 0x9e3779b9 = 0x8c032fc1
[PyNumber_And] 0x123456780 &amp; 0xfa3affff = 0x22006780
[PyNumber_Add] 0x22006780 + 0x00000001 = 0x22006781
[PyNumber_Power] pow(0x00118065, 0x00010001, None) = num
[PyNumber_Remainder] num % 0xfffffffd = 0x8c219e43
[CompareObj] 0x22006781 == 0x12287f38 -&gt; False

[PyLong_FromString] int(s, base=16) s=87654321 -&gt; 0x87654321
[PyLong_FromUnicodeObject] int(s, base=16) s=87654321 -&gt; 0x87654321
[PyNumber_Xor] 0x87654321 ^ 0x9e3779b9 = 0x19523a98
[PyNumber_And] 0x876543210 &amp; 0xfa3affff = 0x72103210
[PyNumber_Add] 0x72103210 + 0x00000008 = 0x72103218
[PyNumber_Power] pow(0x00032a47, 0x00010001, None) = num
[PyNumber_Remainder] num % 0xfffffffd = 0x045ca420
[CompareObj] 0x72103218 == 0x4a30f74d -&gt; False

[PyLong_FromString] int(s, base=16) s=12345678 -&gt; 0x12345678
[PyLong_FromUnicodeObject] int(s, base=16) s=12345678 -&gt; 0x12345678
[PyNumber_Xor] 0x12345678 ^ 0x9e3779b9 = 0x8c032fc1
[PyNumber_And] 0x123456780 &amp; 0xfa3affff = 0x22006780
[PyNumber_Add] 0x22006780 + 0x00000001 = 0x22006781
[PyNumber_Power] pow(0x00118065, 0x00010001, None) = num
[PyNumber_Remainder] num % 0xfffffffd = 0x8c219e43
[CompareObj] 0x22006781 == 0x023a1268 -&gt; False

[PyLong_FromString] int(s, base=16) s=87654321 -&gt; 0x87654321
[PyLong_FromUnicodeObject] int(s, base=16) s=87654321 -&gt; 0x87654321
[PyNumber_Xor] 0x87654321 ^ 0x9e3779b9 = 0x19523a98
[PyNumber_And] 0x876543210 &amp; 0xfa3affff = 0x72103210
[PyNumber_Add] 0x72103210 + 0x00000008 = 0x72103218
[PyNumber_Power] pow(0x00032a47, 0x00010001, None) = num
[PyNumber_Remainder] num % 0xfffffffd = 0x045ca420
[CompareObj] 0x72103218 == 0x88108807 -&gt; False
[CompareObj] 0x00003558 == 0x00003558 -&gt; True
</code></pre><p>æ˜æ˜¾çš„4éƒ¨åˆ†ï¼Œè¿™ä¸çˆ½å¤šäº†å˜›hhhhhhhhhhhh</p><p>è°ƒå‡ºæ¥ä¸€éƒ¨åˆ†çœ‹ï¼š</p><pre><code>[PyLong_FromString] int(s, base=16) s=12345678 -&gt; 0x12345678
[PyLong_FromUnicodeObject] int(s, base=16) s=12345678 -&gt; 0x12345678
[PyNumber_Xor] 0x12345678 ^ 0x9e3779b9 = 0x8c032fc1
[PyNumber_And] 0x123456780 &amp; 0xfa3affff = 0x22006780
[PyNumber_Add] 0x22006780 + 0x00000001 = 0x22006781
[PyNumber_Power] pow(0x00118065, 0x00010001, None) = num
[PyNumber_Remainder] num % 0xfffffffd = 0x8c219e43
[CompareObj] 0x22006781 == 0x12287f38 -&gt; False</code></pre><p>å¤ç°çš„ï¼š</p><pre><code>input^0x9e3779b9
a1 = (input0 &amp; 0xfa3affff) + 0x00000001
a2 = pow(x,0x00118065,) % 0xfffffffd</code></pre><p>çœŸå®çš„ï¼š</p><pre><code>ç¬¬ä¸€ä¸ªè¿”å›å€¼ï¼š((int(n,16)^2654435769)&gt;&gt;11)**65537%4294967293 
ç¬¬äºŒä¸ªè¿”å›å€¼ï¼š((int(n,16)&lt;&lt;4)&amp;4198170623)+((n&gt;&gt;5)&gt;&gt;23)</code></pre><p>å°±å·®å‡ ä¸ªç§»ä½è¿ç®—ï¼Œä¸€åŠ¨æ€å°±å‡ºï¼Œå¥½çš„ï¼Œçˆ½ï¼</p><h3 id=54045883_æ€»ç»“>æ€»ç»“</h3><p>å—¯ï¼Œé™¤äº†å‡ ä¸ªç§»ä½æˆ–è€…å–å€¼æ“ä½œæ•æ‰ä¸åˆ°ï¼Œå…¶ä»–çš„ï¼Œç®€ç›´æ˜¯é™ç»´<br> æƒ³teaç­‰å¸¸è§„åŠ å¯†ï¼Œç›´æ¥å°±èƒ½çœ‹å‡ºæ¥ï¼Œç”¨æ¥traceä¸€ä¸‹ï¼Œé’ˆä¸æˆ³</p><p>ä¸è¿‡è¿˜æ˜¯å¾—åŠ¨è°ƒï¼Œä¸èƒ½ç›´æ¥ä¸¢å¼ƒidaï¼Œå“</p><div class=parsedown-markdown-end_FLAG_ZXSQ style=display:none></div>å“[/md] </div></div></body></html>